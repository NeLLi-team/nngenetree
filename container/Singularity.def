Bootstrap: docker
From: condaforge/mambaforge:latest

%help
    NNGeneTree Singularity container
    A phylogenetic pipeline for analyzing gene sequences.
    
    Usage:
    singularity run --bind /path/to/input:/data/input,/path/to/output:/data/output nngenetree.sif

%labels
    Maintainer Frederik Boulund
    Version 0.9.0
    Description NNGeneTree pipeline for gene tree analysis

%environment
    export PATH=/opt/conda/bin:$PATH
    export PYTHONPATH=/nngenetree:$PYTHONPATH
    export LC_ALL=C

%files
    workflow /nngenetree/workflow
    container/scripts /nngenetree/container/scripts
    container/environment.yml /nngenetree/container/environment.yml
    example /nngenetree/example

%post
    # Set non-interactive frontend and timezone
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime
    
    # Install system dependencies
    apt-get update && apt-get install -y \
        procps wget git build-essential \
        python3-pyqt5 qtbase5-dev qt5-qmake xvfb \
        libgl1-mesa-glx libegl1-mesa libxrender1 libxcomposite1 \
        libdbus-1-3 libfontconfig1 libxkbcommon-x11-0 libxi6 libxtst6 \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*
    
    # Set up conda environment
    cd /nngenetree
    
    # Create and activate the project environment
    mamba env create -f container/environment.yml
    mamba clean -a -y
    
    # Run setup script
    chmod +x /nngenetree/container/scripts/setup.sh
    /nngenetree/container/scripts/setup.sh
    
    # Create directories for binding
    mkdir -p /data/input /data/output /blast_db /workdir

%runscript
    # Source conda environment
    . /opt/conda/etc/profile.d/conda.sh
    conda activate nngenetree
    
    # Execute the command
    exec snakemake "$@"

%startscript
    echo "NNGeneTree container is ready!"
    echo "Please bind your input and output directories:"
    echo "singularity run --bind /path/to/input:/data/input,/path/to/output:/data/output nngenetree.sif"